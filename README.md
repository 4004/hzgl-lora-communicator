# hzgl-lora-communicator

["hzgl-lora-communicator"](https://github.com/HouzuoGuo/hzgl-lora-communicator)
is an [open source](https://github.com/HouzuoGuo/hzgl-lora-communicator/blob/master/LICENSE)
software for a battery-powered two-way messaging device. It uses [The Things Network Community Edition](https://www.thethingsindustries.com/docs/getting-started/ttn/)
(LoRaWAN) for bi-directional data connectivity.

## Features

- Free to use with good coverage in nearly all major cities [around the world](https://www.thethingsnetwork.org/map).
  * Note: as of December 2021, the software is configured to work in Europe.
    This may be improved in the future.
- Send text messages up to 100 characters in length.
- Receive text messages up to 50 characters in length.
- Display and transmit GPS location.
- Display and transmit environment (temperature, humidity, pressure) readings.
- Fox-hunt nearby 2.4GHz WiFi and Bluetooth LE transmitters.

## Supported hardware

As of December 2021, the software exclusively targets the TTGO T-Beam board
revision v1.1. In addition, the software is configured to work with European
cities by using the `EU868` frequency plan. These may change in the future.

"TTGO T-Beam" is an IoT development board manufactured by Chinese company
["LILYGO"](https://twitter.com/lilygo9). The board features:

- An ESP32 microcontroller with built-in 2.4GHz WiFi and Bluetooth LE
  transceivers.
- A LoRa transceiver.
- A GPS receiver and its ceramic antenna.
- A battery holder for 3.7V 18650 cell.
- A 0.96 inch OLED.
  * The display is often sold as an add-on.
- A BME280 environment (temperature, humidity, and pressure) sensor.
  * The software will continue to function even without this sensor.
  * Be aware that some Chinese merchants deceive buyers by shipping them BMP280
    sensors. The software does not support BMP280.

<img src="todo" />

## Get started

Navigate to The Things Network Community Edition [console](https://eu1.cloud.thethings.network/console/)
and create a new application dedicated to LoRa communicators. Navigate to the
newly created application and go to "Payload formatters", "Uplink". Choose
Javascript as the "Formatter type", and paste the content of
[ttn_v3_uplink_payload_formatter.js](https://github.com/HouzuoGuo/hzgl-lora-communicator/blob/master/ttn_v3_uplink_payload_formatter.js)
into the "Formatter parameter" text area.

Next, navigate to "End devices" and create a new end device:

- Skip selecting a brand for this device. Go to manual device registration.
- Frequency plan: choose `Europe 863-870 MHz (SF9 for RX2 - recommended)`.
- LoRaWAN version: choose `MAC V1.0.2`.
- Regional Parameters version: choose `PHY V1.0.2 REV B`
- Click "Show advanced activation, LoRaWAN class and cluster settings".
- Activation mode: choose `Activation by personalization (ABP)`.
  * As of December 2021, the software does not yet support OTAA.
- Uncheck "Use network's default MAC settings".
- Rx1 data rate offset: enter `0`.
- Rx1 delay: enter `1`.
- Resets frame counters: check (yes).
- Rx2 data rate: enter `3`
  * The data rate number matches the combination of 125KHz bandwidth and
    spreading factor 9, which was previously picked in the frequency plan.
- Rx2 frequency: enter `869525000`.
- Factory preset frequencies, enter `867100000`, `867300000`, `867500000`,
  `867700000`, `867900000`, `868100000`, `868300000`, `868500000`, one in each
  text box.
- End device ID: enter a recognisable name for the device.

Click the "Generate" button next to DevEUI, Device address, AppSKey, and NwkSKey.
Next, view the newly created device and go to "General settings", expand
"Network layer" and "Application layer" and note down the generated parameter
values - they will be used to construct a `lorawan_creds.h` file later on.

Go to "Network layer" and expand "Advanced MAC settings". Correct any derivation
from the following configuration:

- Rx1 and desired delay: `1`
- Rx1 and desired data rate offset: `0`
- Resets frame counters: yes
- Rx2 and desired data rate index: `3`
- Rx2 and desired frequency: `869525000`
- Maximum and desired duty cycle: `100%`
- Factory preset frequencies: `867100000`, `867300000`, `867500000`,
  `867700000`, `867900000`, `868100000`, `868300000`, `868500000`
- Status count periodicity: `200`
- Status time periodicity: `86400`
- Use ADR: no

All of the parameters must match - otherwise there is a high likelihood of not
being able to transmit of receive text messages!

Clone the repository and create a new text file `include/lorawan_creds.h` with
the following content:

``` c++
#pragma once
// Substitute # with the parameter values generated by the console.
static const u1_t PROGMEM NWKSKEY[16] = {0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##};
static const u1_t PROGMEM APPSKEY[16] = {0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##, 0x##};
static const u4_t DEVADDR = 0x########;
```

Plug-in the TTGO T-Beam to the computer, open Device Manager and expand
"Ports (COM & LPT)", take note of the COM port number. Edit `platformio.ini` and
change change `dev_board_serial_port = COM#` to the COM port number.

Finally, install VSCode and Platform.IO plugin, open the cloned repository and
execute command `PlatformIO: Upload`.

## Usage

## Copyright

Copyright (C) 2021 Google Inc. All rights reserved.

This program is free software subject to the terms of GNU Public License, v 3.0.
You may find the license text in the [LICENSE file](https://github.com/HouzuoGuo/hzgl-lora-communicator/blob/master/LICENSE).

This is not an officially supported Google product.
